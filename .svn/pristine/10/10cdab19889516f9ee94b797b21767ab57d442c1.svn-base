draw2d=draw2d||{};draw2d.policy=draw2d.policy||{};draw2d.policy.canvas=draw2d.policy.canvas||{};draw2d.policy.canvas.layout=draw2d.policy.canvas.layout||{};draw2d.util.ArrayList.prototype.slice=function(c,a){var b=this.data.slice(c,a);return new draw2d.util.ArrayList(b)};draw2d.util.ArrayList.prototype.clear=function(){this.data=[]};draw2d.util.FigureManager=Class.extend({NAME:"draw2d.util.FigureManager",init:function(){var a=this;a.figuresMap=new draw2d.util.HashMap();a.figureIdsMap=new draw2d.util.HashMap()},addFigure:function(a){var b=this,c=a.getFigureType(),d=b.getFiguresMap().get(c);b.getFigureIdsMap().put(a.getId(),a);if(!c){console.log("在向图元管理器注册时未获取到该图元的类名");return}if(d){d.add(a)}else{b.getFiguresMap().put(c,new draw2d.util.ArrayList([a]))}},removeFigure:function(a){var c=this,b=a.getId(),d=a.getFigureType(),e=null;c.getFigureIdsMap().remove(b);if(!d){return}e=c.getFiguresMap().get(d);e.remove(a)},updateFigureID:function(b,a){this.getFigureIdsMap().remove(b);this.getFigureIdsMap().put(a.getId(),a)},getFigureListByFigureType:function(a){return this.getFiguresMap().get(a)},getFigureById:function(a){return this.getFigureIdsMap().get(a)},getFigureIdsMap:function(){if(this.figureIdsMap){return this.figureIdsMap}else{throw"未正确创建图元id集合"}},getFiguresMap:function(){if(this.figuresMap){return this.figuresMap}else{throw"未正确创建图元figure集合"}}});draw2d.util.GroupManager=Class.extend({NAME:"draw2d.util.GroupManager",init:function(){var a=this;a.groupsMap=new draw2d.util.HashMap()},addFigure:function(b,a){var d=this,c=d.groupsMap.get(b);if(c){c.addFigure(a)}else{c=new draw2d.util.FigureManager();c.addFigure(a);d.groupsMap.put(b,c)}},removeFigure:function(b,a){var d=this,c=d.getFigureMngByGroupType(b);if(c){c.removeFigure(a)}},updateFigureID:function(b,e,a){var d=this,c=d.getFigureMngByGroupType(b);c.updateFigureID(e,a)},getFigureListByFigureType:function(a,c){var d=this,b=d.getFigureMngByGroupType(a);if(b){return b.getFigureListByFigureType(c)}else{return null}},getFigureById:function(a,d){var c=this,b=c.getFigureMngByGroupType(a);if(!b){return null}return b.getFigureById(d)},getFigureIdsMap:function(a){var c=this,b=c.getFigureMngByGroupType(a);if(b.figureIdsMap){return b.figureIdsMap}else{throw"未正确创建图元id集合"}},getFiguresMap:function(a){var c=this,b=c.getFigureMngByGroupType(a);if(b.figuresMap){return b.figuresMap}else{throw"未正确创建图元figure集合"}},getFigureMngByGroupType:function(a){var c=this,b=c.groupsMap.get(a);if(!b){return null}return b}});draw2d.util.HashMap=Class.extend({NAME:"draw2d.util.HashMap",size:0,entry:null,init:function(a){var b=this;b.size=0;b.entry={}},put:function(a,b){if(!this.containsKey(a)){this.size++}this.entry[a]=b},clear:function(){var a=this;a.size=0;a.entry={}},get:function(a){if(this.containsKey(a)){return this.entry[a]}else{return null}},remove:function(a){if(delete this.entry[a]){this.size--}},removeAll:function(a){var b=this;b.entry={}},containsKey:function(a){return(a in this.entry)},containsValue:function(a){for(var b in this.entry){if(this.entry[b]==a){return true}}return false},values:function(){var a=[];for(var b in this.entry){a.push(this.entry[b])}return a},keys:function(){var a=[];for(var b in this.entry){a.push(b)}return a},getSize:function(){return this.size},each:function(b){for(var a in this.entry){if(b(a,this.entry[a])===false){break}}}});draw2d.Canvas.prototype.init=function(f,e,a,b){var g=this;g.setContainer(b);if(navigator.appName=="Microsoft Internet Explorer"){var c=navigator.userAgent;var d=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");if(d.exec(c)!=null){rv=parseInt(RegExp.$1);if(rv===8){this.fromDocumentToCanvasCoordinate=this._fromDocumentToCanvasCoordinate_IE8_HACK}}}this.setScrollArea("#"+f);this.canvasId=f;this.html=$("#"+f);this.html.css({cursor:"default"});if(typeof e!=="undefined"){this.initialWidth=e;this.initialHeight=a;this.setWidth(e);this.setHeight(a)}else{this.initialWidth=this.getHtmlWidth();this.initialHeight=this.getHtmlHeight()}this.html.css({"-webkit-tap-highlight-color":"rgba(0,0,0,0)"});if(typeof this.html.droppable!=="undefined"){this.html.droppable({accept:".dragDropArea",over:function(h,i){g.onDragEnter(i.draggable)},out:function(h,i){g.onDragLeave(i.draggable)},drop:function(h,i){h=g._getEvent(h);var j=g.fromDocumentToCanvasCoordinate(h.clientX,h.clientY);g.onDrop(i.draggable,j.getX(),j.getY(),h.shiftKey,h.ctrlKey)}});$(".dragDropArea").draggable({appendTo:"body",stack:"body",zIndex:27000,helper:"clone",drag:function(h,i){h=g._getEvent(h);var j=g.fromDocumentToCanvasCoordinate(h.clientX,h.clientY);g.onDrag(i.draggable,j.getX(),j.getY(),h.shiftKey,h.ctrlKey)},stop:function(i,h){},start:function(i,h){$(h.helper).addClass("shadow")}})}if(typeof a!=="undefined"){this.paper=Raphael(f,e,a)}else{this.paper=Raphael(f,this.getWidth(),this.getHeight())}this.paper.canvas.style.position="absolute";this.zoomFactor=1;this.selection=new draw2d.Selection();this.currentDropTarget=null;this.currentHoverFigure=null;this.eventSubscriptions={};this.editPolicy=new draw2d.util.ArrayList();this.figures=new draw2d.util.ArrayList();this.lines=new draw2d.util.ArrayList();this.commonPorts=new draw2d.util.ArrayList();this.dropTargets=new draw2d.util.ArrayList();this.resizeHandles=new draw2d.util.ArrayList();this.commandStack=new draw2d.command.CommandStack();this.linesToRepaintAfterDragDrop=new draw2d.util.ArrayList();this.lineIntersections=new draw2d.util.ArrayList();this.installEditPolicy(new draw2d.policy.canvas.DefaultKeyboardPolicy());this.installEditPolicy(new draw2d.policy.canvas.BoundingboxSelectionPolicy());this.installEditPolicy(new draw2d.policy.canvas.ConnectionInterceptorPolicy());this.commandStack.addEventListener(function(h){if(h.isPostChangeEvent()===true){g.calculateConnectionIntersection();g.linesToRepaintAfterDragDrop.each(function(k,j){j.svgPathString=null;j.repaint()});g.linesToRepaintAfterDragDrop=new draw2d.util.ArrayList()}});this.mouseDown=false;this.mouseDownX=0;this.mouseDownY=0;this.mouseDragDiffX=0;this.mouseDragDiffY=0;this.html.bind("mouseup touchend",function(h){if(g.mouseDown===false){return}h=g._getEvent(h);g.calculateConnectionIntersection();g.mouseDown=false;var i=g.fromDocumentToCanvasCoordinate(h.clientX,h.clientY);g.editPolicy.each(function(j,k){k.onMouseUp(g,i.x,i.y,h.shiftKey,h.ctrlKey)});g.mouseDragDiffX=0;g.mouseDragDiffY=0});this.html.bind("mousemove touchmove",function(k){k=g._getEvent(k);if(g.mouseDown===false){var m=g.fromDocumentToCanvasCoordinate(k.clientX,k.clientY);try{var j=g.getBestFigure(m.x,m.y);if(j!==g.currentHoverFigure&&g.currentHoverFigure!==null){g.currentHoverFigure.onMouseLeave()}if(j!==g.currentHoverFigure&&j!==null){j.onMouseEnter(k.clientX,k.clientY)}if(j==g.currentHoverFigure&&j!==null&&j.onMouseMove){j.onMouseMove(k.clientX,k.clientY)}g.currentHoverFigure=j}catch(h){console.log(h)}g.editPolicy.each(function(n,o){o.onMouseMove(g,m.x,m.y,k.shiftKey,k.ctrlKey)})}else{var l=(k.clientX-g.mouseDownX)*g.zoomFactor;var i=(k.clientY-g.mouseDownY)*g.zoomFactor;g.editPolicy.each(function(n,o){o.onMouseDrag(g,l,i,l-g.mouseDragDiffX,i-g.mouseDragDiffY)});g.mouseDragDiffX=l;g.mouseDragDiffY=i}});this.html.bind("mousedown touchstart",function(i){try{var j=null;switch(i.which){case 1:case 0:i.preventDefault();i=g._getEvent(i);g.mouseDownX=i.clientX;g.mouseDownY=i.clientY;g.mouseDragDiffX=0;g.mouseDragDiffY=0;j=g.fromDocumentToCanvasCoordinate(i.clientX,i.clientY);g.mouseDown=true;g.editPolicy.each(function(k,l){l.onMouseDown(g,j.x,j.y,i.shiftKey,i.ctrlKey)});break;case 3:i.preventDefault();i=g._getEvent(i);j=g.fromDocumentToCanvasCoordinate(i.clientX,i.clientY);g.onRightMouseDown(j.x,j.y,i.shiftKey,i.ctrlKey);break;case 2:break;default:}}catch(h){console.log(h)}});this.html.bind("dblclick",function(h){h=g._getEvent(h);g.mouseDownX=h.clientX;g.mouseDownY=h.clientY;var i=g.fromDocumentToCanvasCoordinate(h.clientX,h.clientY);g.onDoubleClick(i.x,i.y,h.shiftKey,h.ctrlKey)});this.html.bind("click",function(h){if(g.canvasContainer&&g.canvasContainer.getContainerPanel){g.canvasContainer.getContainerPanel().focus()}h=g._getEvent(h);if(g.mouseDownX===h.clientX||g.mouseDownY===h.clientY){var i=g.fromDocumentToCanvasCoordinate(h.clientX,h.clientY);g.onClick(i.x,i.y,h.shiftKey,h.ctrlKey)}});this.keyupCallback=function(h){var i=$(h.target);if(!i.is("input")&&!i.is("textarea")){g.editPolicy.each(function(j,k){if(k instanceof draw2d.policy.canvas.KeyboardPolicy){k.onKeyUp(g,h.keyCode,h.shiftKey,h.ctrlKey)}})}};$(document).bind("keyup",this.keyupCallback);this.keydownCallback=function(h){var i=$(h.target);if(!i.is("input")&&!i.is("textarea")){g.editPolicy.each(function(j,k){if(k instanceof draw2d.policy.canvas.KeyboardPolicy){k.onKeyDown(g,h.keyCode,h.shiftKey,h.ctrlKey)}})}};$(document).bind("keydown",this.keydownCallback);this.html.bind("scroll",function(h){var j=g.getScrollLeft(),i=g.getScrollTop()});this.groupManager=new draw2d.util.GroupManager()};draw2d.Canvas.prototype.getEditPolicy=function(){return this.editPolicy};draw2d.Canvas.prototype.getWidth=function(){return this.width};draw2d.Canvas.prototype.setWidth=function(a){this.width=a};draw2d.Canvas.prototype.getHeight=function(){return this.height};draw2d.Canvas.prototype.setHeight=function(a){this.height=a};draw2d.Canvas.prototype.getHtmlHeight=function(){return this.html.height()};draw2d.Canvas.prototype.getHtmlWidth=function(){return this.html.width()};draw2d.Canvas.prototype.onMouseMoveCanvas=function(l,j,e,c){var d=this,i=d.getZoom(),g=d.getViewBoxX(),f=d.getViewBoxY(),h=(d.initialWidth*(i))|0,b=(d.initialHeight*(i))|0,a,k;d.changeMouseType("hand");a=g-e;k=f-c;if(a<0||k<0){return}d.setViewBoxX(a);d.setViewBoxY(k);d.paper.setViewBox(a,k,h,b);d.fireEvent("canvas_move",{dx:l,dy:j,dx2:e,dy2:c})};draw2d.Canvas.prototype.rePosition=function(g,c,a){var d=this,h=d.getZoom(),f=g.x*c,e=g.y*c;var i=(d.initialWidth*(h))|0;var b=(d.initialHeight*(h))|0;d.setViewBoxX(f);d.setViewBoxY(e);d.paper.setViewBox(f,e,i,b)};draw2d.Canvas.prototype.add=function(b,a,c){if(b.getCanvas()===this){return}if(b instanceof draw2d.shape.basic.Line){this.lines.add(b);this.linesToRepaintAfterDragDrop=this.lines}else{this.figures.add(b);if(typeof c!=="undefined"){b.setPosition(a,c)}else{if(typeof a!=="undefined"){b.setPosition(a)}}}b.setCanvas(this);b.getShapeElement();b.repaint();this.fireEvent("figure:add",{figure:b});b.fireEvent("added");b.fireEvent("move");this.getGroupManager().addFigure(b.getFigureGroup(),b);return this};draw2d.Canvas.prototype.remove=function(a){var b=this;this.editPolicy.each(function(c,d){if(typeof d.unselect==="function"){d.unselect(b,a)}});if(a instanceof draw2d.shape.basic.Line){this.lines.remove(a)}else{this.figures.remove(a)}a.setCanvas(null);if(a instanceof draw2d.Connection){a.disconnect()}this.fireEvent("figure:remove",{figure:a});this.getGroupManager().removeFigure(a.getFigureGroup(),a);return this};draw2d.Canvas.prototype.removeAll=function(){var b=this,a=b.figures.clone();a.each(function(d,c){if(c){b.remove(c)}})},draw2d.Canvas.prototype.getGroupManager=function(){if(this.groupManager){return this.groupManager}else{throw"图元索引管理器未创建"}};draw2d.Canvas.prototype.getLine=function(a,b){return this.getGroupManager().getFigureById(a,b)};draw2d.Canvas.prototype.getFigure=function(a,b){return this.getGroupManager().getFigureById(a,b)};draw2d.Canvas.prototype.getFigureById=function(b){var a=null;this.figures.each(function(c,d){if(d.id===b){a=d;return false}});return a};draw2d.Canvas.prototype.onRightMouseDown=function(c,f,d,e){var b=this.getBestFigure(c,f);while((b!==null&&b.getParent()!==null)&&!(b instanceof draw2d.Port)){b=b.getParent()}this.setCurrentSelection(b);var a=this.fromCanvasToDocumentCoordinate(c,f);this.fireEvent("contextmenu",{x:a.x,y:a.y,shiftKey:d,ctrlKey:e,figure:b});if(b!==null){b.fireEvent("contextmenu",{x:c,y:f});b.onContextMenu(c,f);b.editPolicy.each(function(g,h){h.onRightMouseDown(b,c,f,d,e)})}this.editPolicy.each(function(g,h){h.onRightMouseDown(b,c,f,d,e)})};draw2d.Canvas.prototype.removeFigureByType=function(d,c){var b=this,e,a="";e=b.getGroupManager().getFigureListByFigureType(d,c),figureListClone=null;if(e!=null&&e instanceof draw2d.util.ArrayList){figureListClone=e.clone();figureListClone.each(function(g,f){b.remove(f)})}};draw2d.Canvas.prototype.initAddLink=function(b,a){var c=this;c.setAddLinkState(true);c.setDblClicked(a);c.setCurrentModel(b);var d=c.editPolicy.clone();d.grep(function(e){if(e instanceof draw2d.policy.canvas.SingleSelectionPolicy){c.uninstallEditPolicy(e)}return true});if(!c.tempAddlinkPolicy){c.tempAddlinkPolicy=new draw2d.policy.canvas.AddLinkPolicy()}c.installEditPolicy(c.tempAddlinkPolicy);c.changeMouseType("default")};draw2d.Canvas.prototype.initDragDropCanvas=function(){var a=this;a.setAddLinkState(false);a.setDblClicked(false);a.setCurrentModel(null);var b=a.editPolicy.clone();b.grep(function(c){if(c instanceof draw2d.policy.canvas.SingleSelectionPolicy){a.uninstallEditPolicy(c)}return true});if(!a.tempDragDropCanvasPolicy){a.tempDragDropCanvas=new draw2d.policy.canvas.DragDropCanvasPolicy()}a.installEditPolicy(a.tempDragDropCanvas);a.changeMouseType("hand")};draw2d.Canvas.prototype.getOutOfAddLinkState=function(a,b){var c=this;c.setAddLinkState(false);c.setDblClicked(b);c.setCurrentModel(a);var d=c.editPolicy.clone();d.grep(function(e){if(e instanceof draw2d.policy.canvas.SingleSelectionPolicy){c.uninstallEditPolicy(e)}return true});if(!c.tempSelectPolicy){c.tempSelectPolicy=new draw2d.policy.canvas.BoundingboxSelectionPolicy()}c.installEditPolicy(c.tempSelectPolicy);c.changeMouseType("default")};draw2d.Canvas.prototype.changeMouseType=function(a){this.html.css({cursor:a})};draw2d.Canvas.prototype.setCurrentModel=function(a){this.currentModel=a};draw2d.Canvas.prototype.getCurrentModel=function(){return this.currentModel};draw2d.Canvas.prototype.setDblClicked=function(a){this.dblClicked=a};draw2d.Canvas.prototype.isDblClicked=function(){return this.dblClicked};draw2d.Canvas.prototype.setAddLinkState=function(a){this.inAddLinkState=a};draw2d.Canvas.prototype.getAddLinkState=function(){return this.inAddLinkState};draw2d.Canvas.prototype.setZoom=function(c,b){var e=this;var a=function(j){e.zoomFactor=Math.min(Math.max(0.01,j),10);var i=(e.initialWidth*(e.zoomFactor))|0;var h=(e.initialHeight*(e.zoomFactor))|0;var g=e.getViewBoxX();var f=e.getViewBoxY();e.paper.setViewBox(g,f,i,h);e.fireEvent("zoom",{factor:e.zoomFactor})};if(b){var d=new Tweenable();d.tween({from:{x:this.zoomFactor},to:{x:c},duration:300,easing:"easeOutSine",step:function(f){a(f.x)}})}else{a(c)}};draw2d.Canvas.prototype.setViewBoxX=function(a){this.viewBoxX=a};draw2d.Canvas.prototype.getViewBoxX=function(){return this.viewBoxX?this.viewBoxX:0};draw2d.Canvas.prototype.setViewBoxY=function(a){this.viewBoxY=a};draw2d.Canvas.prototype.getViewBoxY=function(){return this.viewBoxY?this.viewBoxY:0};draw2d.Canvas.prototype.fromDocumentToCanvasCoordinate=function(a,b){return new draw2d.geo.Point((a-this.getAbsoluteX())*this.zoomFactor+this.getViewBoxX(),(b-this.getAbsoluteY())*this.zoomFactor+this.getViewBoxY())};draw2d.Canvas.prototype._fromDocumentToCanvasCoordinate_IE8_HACK=function(a,b){return new draw2d.geo.Point((a-this.getAbsoluteX())*this.zoomFactor,(b-this.getAbsoluteY())*this.zoomFactor)};draw2d.Canvas.prototype.fromCanvasToDocumentCoordinate=function(a,b){return new draw2d.geo.Point(((a*(1/this.zoomFactor))+this.getAbsoluteX()-this.getViewBoxX()),((b*(1/this.zoomFactor))+this.getAbsoluteY()-this.getViewBoxY()))};draw2d.Canvas.prototype.onDoubleClick=function(b,e,c,d){var a=this.getBestFigure(b,e);if(a!==null){a.fireEvent("dblclick",{x:b,y:e,shiftKey:c,ctrlKey:d});a.onDoubleClick();this.fireEvent("dblclick",{x:b,y:e,shiftKey:c,ctrlKey:d,figure:a})}this.editPolicy.each(function(f,g){g.onDoubleClick(a,b,e,c,d)})};draw2d.Canvas.prototype.setContainer=function(a){if(a){this.canvasContainer=a}else{this.canvasContainer=null}};draw2d.Canvas.prototype.getContainer=function(){if(this.canvasContainer){return this.canvasContainer}else{console.log("没有设置container");throw ("没有设置container")}};draw2d.Canvas.prototype.getBestFigure=function(j,h,a){if(!$.isArray(a)){if(a instanceof draw2d.Figure){a=[a]}else{a=[]}}var l=null;var e=null;var d=0;var b=null;for(d=0,len=this.resizeHandles.getSize();d<len;d++){e=this.resizeHandles.get(d);if(e.isVisible()===true&&e.hitTest(j,h)===true&&$.inArray(e,a)===-1){return e}}for(d=0,len=this.commonPorts.getSize();d<len;d++){e=this.commonPorts.get(d);if($.inArray(e,a)===-1){if(e.isVisible()===true&&e.hitTest(j,h)===true){return e}}}var c=function(i){i.each(function(m,n){var o=n.figure;c(o.children);if(l&&o.eventIgnoreChildren){return l=o}if(l===null&&o.isVisible()===true&&o.hitTest(j,h)===true&&$.inArray(o,a)===-1){l=o}return l===null})};for(d=(this.figures.getSize()-1);d>=0;d--){var g=this.figures.get(d);c(g.children);if(l&&g.eventIgnoreChildren){return l=g}if(l===null&&g.isVisible()===true&&g.hitTest(j,h)===true&&$.inArray(g,a)===-1){l=g}if(l!==null){return l}}var f=this.lines.getSize();for(d=0;d<f;d++){var k=this.lines.get(d);c(k.children);if(l!==null){return l}}l=this.getBestLine(j,h,a);if(l!==null){return l}return l};draw2d.Connection.prototype.getBoundingPoint=function(c){var h=this,g=h.getSource().getAbsolutePosition(),e=h.getTarget().getAbsolutePosition(),d=new draw2d.shape.basic.PolyLine({startX:g.x,startY:g.y,endX:e.x,endY:e.y});var f=c.getAbsoluteBounds();var b=f.intersectionWithLine(g,e);var a=b.first();if(!a){a=e}return a};draw2d.Connection.prototype.setTargetNode=function(a){if(a.getHybridPort(0)){this.setTarget(a.getHybridPort(0))}else{if(a.getInputPort(0)){this.setTarget(a.getInputPort(0))}else{throw"当前节点无法作为此链接的端点"}}};draw2d.Connection.prototype.getTargetNode=function(){if(this.getTarget()){return this.getTarget().getParent()}else{return null}};draw2d.Connection.prototype.setSourceNode=function(a){if(a.getHybridPort(0)){this.setSource(a.getHybridPort(0))}else{if(a.getOutputPort(0)){this.setTarget(a.getOutputPort(0))}else{throw"当前节点无法作为此链接的端点"}}};draw2d.Connection.prototype.getSourceNode=function(){if(this.getSource()){return this.getSource().getParent()}else{return null}};draw2d.Connection.prototype.onDrag=function(c,b,d,a){if(this.command===null){return}var e=this;this.editPolicy.each(function(f,g){if(g instanceof draw2d.policy.figure.DragDropEditPolicy){g.onDrag(e.canvas,e,c,b,d,a)}});this.svgPathString=null;this.repaint();this.editPolicy.each(function(f,g){if(g instanceof draw2d.policy.figure.DragDropEditPolicy){g.moved(e.canvas,e)}});this.fireEvent("move")};draw2d.Figure.prototype.setPosition=function(a,e){if(a instanceof draw2d.geo.Point){this.x=a.x;this.y=a.y}else{this.x=a;this.y=e}var b={x:this.x,y:this.y};var d=this;this.editPolicy.each(function(g,h){if(h instanceof draw2d.policy.figure.DragDropEditPolicy){var f=h.adjustPosition(d,d.x,d.y);d.x=f.x;d.y=f.y}});var c={x:b.x-this.x,y:b.y-this.y};this.repaint();this.editPolicy.each(function(f,g){if(g instanceof draw2d.policy.figure.DragDropEditPolicy){g.moved(d.canvas,d)}});this.fireEvent("move");this.fireEvent("change:x");this.fireEvent("change:y");this.setRightBottomPoint(a,e);return this};draw2d.Figure.prototype.setRightBottomPoint=function(a,d){var c,b;if(a instanceof draw2d.geo.Point){c=a.x;b=a.y}else{c=a;b=d}this.tx=c+this.getWidth();this.by=b+this.getHeight()};draw2d.Figure.prototype.getTopX=function(){if(this.tx){return this.tx}else{throw"tx 未赋值"}};draw2d.Figure.prototype.getBottomY=function(){if(this.by){return this.by}else{throw"by 未赋值"}};draw2d.Figure.prototype.getLastAppliedAttributes=function(){return this.lastAppliedAttributes};draw2d.Figure.prototype.getClassName=function(){if(this.NAME){return this.NAME}else{throw"当前图元类名未初始化!"}};draw2d.Figure.prototype.setEditable=function(a){this.setSelectable(!!a);this.setDeleteable(!!a);this.setResizeable(!!a);this.setDraggable(!!a)};draw2d.Figure.prototype.getChildren=function(){return this.children};draw2d.Figure.prototype.setId=function(c){var d=this,b=d.getCanvas(),a=null,e=null;if(b&&b instanceof draw2d.Canvas){a=b.getGroupManager();e=d.getId();a.updateFigureID(d.getFigureGroup(),e,d)}d.id=c;return d};draw2d.Figure.prototype.getPersistentAttributes=function(){var a={shape:this.NAME,id:this.id,x:this.getX(),y:this.getY(),width:this.width,height:this.height,alpha:this.alpha};return a};draw2d.Figure.prototype.setUserData=function(a){this.userData=a;this.fireEvent("change:userData");if(a&&a instanceof Dep.framework.editor.model.BaseFigureModel){this.setEditable(a.getEditable());this.setVisible(a.getVisible())}return this};draw2d.Figure.prototype.getFigureType=function(){var a=this.getUserData();if(a&&a instanceof Dep.framework.editor.model.BaseFigureModel){return a.getFType()}return null};draw2d.Figure.prototype.getFigureViewId=function(){var a=this.getUserData();if(a&&a instanceof Dep.framework.editor.model.BaseFigureModel){return a.getViewId()}return null};draw2d.Figure.prototype.getFigureGroup=function(){var a=this.getUserData();if(a&&a instanceof Dep.framework.editor.model.BaseFigureModel){return a.getFigureGroup()}return null};draw2d.Figure.prototype.relocate=function(){this.children.each(function(a,b){b.locator.relocate(a,b.figure)})};draw2d.Port.prototype.getFigureGroup=function(){var b=this,a=b.getParent();return a.getFigureGroup()};draw2d.BussInputPort=draw2d.InputPort.extend({NAME:"draw2d.BussInputPort",MAXFANIN:10,init:function(b,e,a){var c=this;c._super($.extend({bgColor:"#356922",stroke:1,color:"#ffffff",selectable:true},b),e,a);c.locator=new draw2d.layout.locator.OutputPortLocator();var d=c.editPolicy.clone();d.grep(function(f){if(f.NAME==="draw2d.policy.port.IntrusivePortsFeedbackPolicy"){c.uninstallEditPolicy(f)}else{if(f.NAME==="draw2d.policy.figure.RectangleSelectionFeedbackPolicy"){c.uninstallEditPolicy(f)}}return true});c.maxFanIn=c.MAXFANIN;c.name="dafdads";c.installEditPolicy(new draw2d.policy.port.BoundingMovePolicy());c.installEditPolicy(new draw2d.policy.port.PortSelectionPolicy())},getMaxFanIn:function(){return this.maxFanIn},setMaxFanIn:function(a){this.maxFanIn=Math.max(1,a)},createCommand:function(a){if(a.getPolicy()===draw2d.command.CommandType.MOVE){if(!this.isDraggable()){return null}return new draw2d.command.CommandMove(this)}if(a.getPolicy()===draw2d.command.CommandType.CONNECT){return new draw2d.command.CommandConnect(a.canvas,a.source,a.target,a.source)}return null},showTips:function(){var d=this,b=d.getAbsolutePosition(),c=d.getWidth(),a=d.getHeight();b.x+=(c/2);b.y-=(a/2);d.getTips().setPosition(b);d.getTips().setVisible(true)},hideTips:function(){this.getTips().setVisible(false)},getTips:function(){var c=this,a=c.getUserData(),b=a.getBussData().get("name");if(!c.tips){c.tips=new draw2d.shape.basic.FigureLabel(b);c.getCanvas().addFigure(c.getTips())}c.tips.setText(b);return c.tips},onDragStart:function(a,e,b,c){this.isInDragDrop=false;this.command=this.createCommand(new draw2d.command.CommandType(draw2d.command.CommandType.MOVE));if(this.command!==null){this.ox=this.getX();this.oy=this.getY();this.isInDragDrop=true;var d=this;this.editPolicy.each(function(f,g){if(g instanceof draw2d.policy.figure.DragDropEditPolicy){g.onDragStart(d.canvas,d,a,e,b,c)}});return true}return false},onDrag:function(c,b,d,a){var f=this,e=null;f.setGlow(false);this.editPolicy.each(function(h,j){if(j instanceof draw2d.policy.figure.DragDropEditPolicy){var g=j.adjustPosition(f,f.ox+c,f.oy+b);c=g.x-f.ox;b=g.y-f.oy}});this.editPolicy.each(function(g,h){if(h instanceof draw2d.policy.figure.DragDropEditPolicy){h.onDrag(f.canvas,f);if(h.reCaculatePostion){newPos=h.reCaculatePostion(f,c,b,d,a)}}});if(this.getCanSnapToHelper()){newPos=this.getCanvas().snapToHelper(this,newPos)}this.setPosition(newPos);this.fireEvent("move");this.fireEvent("change:x");this.fireEvent("change:y");return},fireEvent:function(c,b){if(this.isInDragDrop){var a=this.isInDragDrop;this.isInDragDrop=false}this._super(c,b);if(a){this.isInDragDrop=a}},onDragEnd:function(a,e,b,c){var d=this;this.command.setPosition(this.x,this.y);this.isInDragDrop=false;this.canvas.getCommandStack().execute(this.command);this.command=null;this.editPolicy.each(function(f,g){if(g instanceof draw2d.policy.figure.DragDropEditPolicy){g.onDragEnd(d.canvas,d,a,e,b,c)}});this.fireEvent("move");this.fireEvent("change:x");this.fireEvent("change:y");if(this.parent){this.parent.layoutPorts()}return},validateConnections:function(){var c=this,b=c.getConnections().getSize(),a=c.getMaxFanIn();return b<a},getPersistentAttributes:function(){var a={shape:this.NAME,id:this.id,x:this.getX(),y:this.getY(),width:this.width,height:this.height,alpha:this.alpha,visible:this.isVisible(),locator:this.getLocator()?this.getLocator().NAME:"",parentId:this.getParent()?this.getParent().getId():"",bgColor:this.bgColor.hash(),color:this.color.hash(),stroke:this.stroke};return a}});draw2d.BussOutputPort=draw2d.OutputPort.extend({NAME:"draw2d.BussOutputPort",init:function(b,c,a){this._super($.extend({bgColor:"#000000",stroke:1,color:"#000000",selectable:false},b),c,a);this.locator=new draw2d.layout.locator.OutputPortLocator();this.setMaxFanOut(1)},onDrop:function(g,a,f,c,d){var e=this,b=e.parent.getCanvas();if(!(g instanceof draw2d.Port)){return false}e.setGlow(false);if(!(g instanceof draw2d.BussInputPort)){return}if(g.getParent()==this.getParent()){return}if(!g.validateConnections()){Dep.framework.editor.util.Msg.info("超出最大链接数");return false}b.fireEvent(Dep.framework.editor.EVENT.CANVAS.ADDCONNECTION,{source:this,target:g,model:b.getCurrentModel(),sourceName:this.getParent().getName(),targetName:g.getParent().getName()});e.setVisible(false)}});draw2d.NoBussHybridPort=draw2d.HybridPort.extend({NAME:"draw2d.NoBussHybridPort",init:function(b,c,a){this._super(b,c,a)},onDrop:function(g,a,f,c,e){if(g instanceof Dep.framework.editor.figure.BaseNode){g=g.getHybridPort()}else{if(g instanceof draw2d.HybridPort){}else{g=null}}if(!g){return}var d=this,b=d.getCanvas();b.fireEvent(Dep.framework.editor.EVENT.CANVAS.ADDCONNECTION,{source:this,target:g,model:b.getCurrentModel(),sourceName:this.getParent().getName(),targetName:g.getParent().getName()});this.setGlow(false)},createCommand:function(a){if(a.getPolicy()===draw2d.command.CommandType.MOVE){if(!this.isDraggable()){return null}return new draw2d.command.CommandMove(this)}if(a.getPolicy()===draw2d.command.CommandType.CONNECT){return new draw2d.command.CommandConnect(a.canvas,a.source,a.target,a.source)}return null}});draw2d.command.Command.prototype.setCanvas=function(a){this.canvas=a};draw2d.command.Command.prototype.getCanvas=function(){if(this.canvas){return this.canvas}else{throw"该command未指定canvas"}};draw2d.command.Command.prototype.getClassName=function(){if(this.NAME){return this.NAME}else{throw"该command未指定NAME"}};draw2d.command.Command.prototype.fireEvent=function(c,a){try{if(typeof this.eventSubscriptions[c]==="undefined"){return}if(this._inEvent===true){return}this._inEvent=true;var d=this.eventSubscriptions[c];for(var b=0;b<d.length;b++){d[b](this,a)}}finally{this._inEvent=false;if(c.substring(0,7)==="change:"){this.fireEvent("change",c.substring(7))}}};draw2d.command.Command.prototype.on=function(d,e,c){var b=d.split(" ");if(c){e=$.proxy(e,c);e.___originalCallback=e}for(var a=0;a<b.length;a++){if(typeof this.eventSubscriptions[b[a]]==="undefined"){this.eventSubscriptions[b[a]]=[]}this.eventSubscriptions[b[a]].push(e)}return this};draw2d.command.Command.prototype.off=function(b){if(typeof b==="undefined"){this.eventSubscriptions={}}else{if(typeof b==="string"){this.eventSubscriptions[b]=[]}else{for(var a in this.eventSubscriptions){this.eventSubscriptions[a]=$.grep(this.eventSubscriptions[a],function(c){if(typeof c.___originalCallback!=="undefined"){return c.___originalCallback!==b}return c!==b})}}}return this};draw2d.command.CommandAlign=draw2d.command.Command.extend({NAME:"draw2d.command.CommandAlign",redoStack:null,init:function(c,e){var f=this,d=0,b=null,a=null;f.setCanvas(c);b=e.clone();for(d=0;d<b.getSize();d++){a=b.get(d);if(a instanceof draw2d.shape.basic.Line){a.unselect();b.remove(a);d--}}f.setFigures(b);f.redoStack=new draw2d.util.ArrayList();f.canUndo=false;f.getMoveCommand()},execute:function(){this.redo()},redo:function(){var a=this;if(!a.canUndo){a.getRedoStack().each(function(b,c){c.redo()});a.getCanvas().addSelection(a.getFigures());a.canUndo=true}},undo:function(){var a=this;if(a.canUndo){a.getRedoStack().each(function(b,c){c.undo()});a.getCanvas().addSelection(a.getFigures());a.canUndo=false}},getMoveCommand:function(){throw"在对齐操作中此方法不应该被调用,请检查"+this.getClassName()+"类中是否重写了getMoveCommand函数"},getClassName:function(){return this.NAME},setFigures:function(a){this.figures=a},getFigures:function(){if(this.figures){return this.figures}else{throw"当前command中没有图元集合"}},getRedoStack:function(){if(this.redoStack){return this.redoStack}else{throw"redoStack 未初始化"}}});draw2d.command.CommandAlignBottom=draw2d.command.CommandAlign.extend({NAME:"draw2d.command.CommandAlignBottom",init:function(a,b){this._super(a,b)},getMoveCommand:function(){var e=this,b=null,g=null,c=0,a=null,f=null,d=e.getFigures();if(d.isEmpty()||d.getSize<=1){return}d.sort("by");b=d.getLastElement();g=b.by;for(c=0;c<d.getSize();c++){a=d.get(c);f=new draw2d.command.CommandMove(a);f.setPosition(a.getX(),g-a.getHeight());e.getRedoStack().add(f)}}});draw2d.command.CommandAlignHCenter=draw2d.command.CommandAlign.extend({NAME:"draw2d.command.CommandAlignHCenter",init:function(a,b){this._super(a,b)},getMoveCommand:function(){var g=this,b=null,f=null,k=null,e=0,j=null,c=null,h=g.getFigures(),a,d;if(h.isEmpty()||h.getSize<=1){return}h.sort("x");a=h.getFirstElement().getX();h.sort("tx");d=h.getLastElement().getTopX();f=d-a;for(e=0;e<h.getSize();e++){j=h.get(e);c=new draw2d.command.CommandMove(j);k=(f-j.getWidth())/2;c.setPosition(a+parseInt(k),j.getY());g.getRedoStack().add(c)}}});draw2d.command.CommandAlignLeft=draw2d.command.CommandAlign.extend({NAME:"draw2d.command.CommandAlignLeft",init:function(a,b){this._super(a,b)},getMoveCommand:function(){var f=this,c=null,b=null,d=0,a=null,g=null,e=f.getFigures();if(e.isEmpty()||e.getSize<=1){return}e.sort("x");c=e.getFirstElement();b=c.x;for(d=1;d<e.getSize();d++){a=e.get(d);g=new draw2d.command.CommandMove(a);g.setPosition(b,a.getY());f.getRedoStack().add(g)}}});draw2d.command.CommandAlignRight=draw2d.command.CommandAlign.extend({NAME:"draw2d.command.CommandAlignRight",init:function(a,b){this._super(a,b)},getMoveCommand:function(){var f=this,c=null,b=null,d=0,a=null,g=null,e=f.getFigures();if(e.isEmpty()||e.getSize<=1){return}e.sort("tx");c=e.getLastElement();b=c.tx;for(d=0;d<e.getSize();d++){a=e.get(d);g=new draw2d.command.CommandMove(a);g.setPosition(b-a.getWidth(),a.getY());f.getRedoStack().add(g)}}});draw2d.command.CommandAlignTop=draw2d.command.CommandAlign.extend({NAME:"draw2d.command.CommandAlignTop",init:function(a,b){this._super(a,b)},getMoveCommand:function(){var e=this,b=null,g=null,c=0,a=null,f=null,d=e.getFigures();if(d.isEmpty()||d.getSize<=1){return}d.sort("y");b=d.getFirstElement();g=b.y;for(c=1;c<d.getSize();c++){a=d.get(c);f=new draw2d.command.CommandMove(a);f.setPosition(a.getX(),g);e.getRedoStack().add(f)}}});draw2d.command.CommandAlignVCenter=draw2d.command.CommandAlign.extend({NAME:"draw2d.command.CommandAlignVCenter",init:function(a,b){this._super(a,b)},getMoveCommand:function(){var g=this,c=null,b=null,k=null,f=0,j=null,e=null,h=g.getFigures(),a,d;if(h.isEmpty()||h.getSize<=1){return}h.sort("y");a=h.getFirstElement().getY();h.sort("by");d=h.getLastElement().getBottomY();b=d-a;for(f=0;f<h.getSize();f++){j=h.get(f);e=new draw2d.command.CommandMove(j);figureY=(b-j.getHeight())/2;e.setPosition(j.getX(),a+parseInt(figureY));g.getRedoStack().add(e)}}});draw2d.command.CommandEnlarge=draw2d.command.Command.extend({NAME:"draw2d.command.CommandEnlarge",ZOOMFACTOR:1.1,init:function(b,a){var c=this;c.setCanvas(b);c.oldZoomFactor=c.getCanvas().getZoom();if(a){c.zoomFactor=a}else{c.zoomFactor=c.oldZoomFactor/c.ZOOMFACTOR}},execute:function(){this.redo()},redo:function(){this.getCanvas().setZoom(this.zoomFactor)},undo:function(){this.getCanvas().setZoom(this.oldZoomFactor)}});draw2d.command.CommandReduce=draw2d.command.Command.extend({NAME:"draw2d.command.CommandReduce",ZOOMFACTOR:1.1,init:function(a){var b=this;b.setCanvas(a);b.oldZoomFactor=b.canvas.getZoom();b.zoomFactor=b.oldZoomFactor*1.1},execute:function(){this.redo()},redo:function(){this.canvas.setZoom(this.zoomFactor)},undo:function(){this.canvas.setZoom(this.oldZoomFactor)}});draw2d.command.CommandMoveByCenter=draw2d.command.CommandMove.extend({NAME:"draw2d.command.CommandMoveByCenter",init:function(b,a,c){this._super(b,a,c)},setStartPosition:function(a,b){this.oldX=a-this.figure.getWidth()/2;this.oldY=b-this.figure.getHeight()/2},setPosition:function(a,b){this.newX=a-this.figure.getWidth()/2;this.newY=b-this.figure.getHeight()/2}});draw2d.command.CanvasLayoutCommand=draw2d.command.CommandAlign.extend({NAME:"draw2d.command.CanvasLayoutCommand",DEFAULTNUM:5,canvasPanel:null,init:function(c,b,a){this.canvasPanel=c;if(!(b instanceof draw2d.util.ArrayList)&&$.isArray(b)){b=new draw2d.util.ArrayList(b)}this._super(null,b)},getMoveCommand:function(){throw"子类应实现此方法创建图元移动的Command结合,出错的Command为"+this.getClassName()},getCanvasViewWidth:function(){if(this.canvasPanel&&this.canvasPanel.getWidth){return this.canvasPanel.getWidth()}else{throw"未正确设置画布依赖的panel"}},getCanvasViewHeight:function(){if(this.canvasPanel&&this.canvasPanel.getHeight){return this.canvasPanel.getHeight()}else{throw"未正确设置画布依赖的panel"}},redo:function(){var a=this;if(!a.canUndo){a.getRedoStack().each(function(b,c){c.redo()});a.canUndo=true}},undo:function(){var a=this;if(a.canUndo){a.getRedoStack().each(function(b,c){c.undo()});a.canUndo=false}},getMaxWidth:function(){var c=this,a=c.getFigures(),b=0;a.each(function(e,d){if(b<d.getWidth()){b=d.getWidth()}});return b},getMaxHeight:function(){var b=this,a=b.getFigures(),c=0;a.each(function(e,d){if(c<d.getHeight()){c=d.getHeight()}});return c}});draw2d.command.CanvasSudokuLayoutCommand=draw2d.command.CanvasLayoutCommand.extend({NAME:"draw2d.command.CanvasSudokuLayoutCommand",maxWidth:0,maxHeight:0,ROWGAP:25,COLUMNGAP:15,initPosition:{x:100,y:100},init:function(b,a){this._super(b,a)},getMoveCommand:function(){var c=this,d=c.getFigures(),k=c.getCanvasViewWidth(),a=d.getSize(),j=0,h=0,b=null,f=0,i=0,g=0,e=0;c.maxHeight=this.getMaxHeight();c.maxWidth=this.getMaxWidth();j=Math.floor(k/(c.maxWidth+c.COLUMNGAP));h=Math.ceil(a/j);d.each(function(m,l){b=new draw2d.command.CommandMoveByCenter(l);f=Math.floor(m/j);i=m%j;g=c.initPosition.x+(i-1)*c.maxWidth+c.maxWidth/2+c.COLUMNGAP*i;e=c.initPosition.y+(f-1)*c.maxHeight+c.maxHeight/2+c.ROWGAP*f;b.setPosition(g,e);c.getRedoStack().add(b)})}});draw2d.command.CanvasHorizontalLayoutCommand=draw2d.command.CanvasLayoutCommand.extend({NAME:"draw2d.command.CanvasHorizontalLayoutCommand",DEFAULTNUM:5,COLUMNSPACE:10,ROWSPACE:10,INITPOSITION:{x:100,y:100},init:function(b,c,a){this._super(b,c);if(a){this.DEFAULTNUM=a}},getMoveCommand:function(){var g=this,d=g.getFigures(),b=null,f=0,a=0,h=null,c=g.INITPOSITION.y,e=g.INITPOSITION.x;if(d instanceof draw2d.util.ArrayList){b=d.getSize();f=(b/g.DEFAULTNUM)+1;for(a;a<=(b/g.DEFAULTNUM);a++){h=d.slice(a*g.DEFAULTNUM,(a+1)*g.DEFAULTNUM);g.repositionFigures(h,e,c)}}},repositionFigures:function(e,d,c){var f=this,b=0,a=0,g=0;e.each(function(i,h){command=new draw2d.command.CommandMove(h);a=d+g+i*f.COLUMNSPACE;g=g+h.getWidth();command.setPosition(a,c);if(b<h.getHeight()){b=h.getHeight()}f.getRedoStack().add(command)});return d+b}});draw2d.command.CanvasCircleLayoutCommand=draw2d.command.CommandAlign.extend({NAME:"draw2d.command.CanvasCircleLayoutCommand",init:function(a,b){this._super(a,b)},getMoveCommand:function(){var e=this,b=null,g=null,c=0,a=null,f=null,d=e.getFigures();if(d.isEmpty()||d.getSize<=1){return}d.sort("by");b=d.getLastElement();g=b.by;for(c=0;c<d.getSize();c++){a=d.get(c);f=new draw2d.command.CommandMove(a);f.setPosition(a.getX(),g-a.getHeight());e.getRedoStack().add(f)}}});draw2d.command.CommandStack.prototype.init=function(){this.undostack=[];this.redostack=[];this.maxundo=50;this.transactionCommand=null;this.eventListeners=new draw2d.util.ArrayList();this.eventSubscriptions={}};draw2d.command.CommandStack.prototype.execute=function(a){this.fireEvent("commandexecute",a)};draw2d.command.CommandStack.prototype.fireEvent=function(c,a){try{if(typeof this.eventSubscriptions[c]==="undefined"){return}if(this._inEvent===true){return}this._inEvent=true;var d=this.eventSubscriptions[c];for(var b=0;b<d.length;b++){d[b](this,a)}}finally{this._inEvent=false;if(c.substring(0,7)==="change:"){this.fireEvent("change",c.substring(7))}}};draw2d.command.CommandStack.prototype.on=function(d,e,c){var b=d.split(" ");if(c){e=$.proxy(e,c);e.___originalCallback=e}for(var a=0;a<b.length;a++){if(typeof this.eventSubscriptions[b[a]]==="undefined"){this.eventSubscriptions[b[a]]=[]}this.eventSubscriptions[b[a]].push(e)}return this};draw2d.command.CommandStack.prototype.off=function(b){if(typeof b==="undefined"){this.eventSubscriptions={}}else{if(typeof b==="string"){this.eventSubscriptions[b]=[]}else{for(var a in this.eventSubscriptions){this.eventSubscriptions[a]=$.grep(this.eventSubscriptions[a],function(c){if(typeof c.___originalCallback!=="undefined"){return c.___originalCallback!==b}return c!==b})}}}return this};draw2d.command.CommandVerticalTreeLayout=draw2d.command.CanvasLayoutCommand.extend({NAME:"draw2d.command.CommandVerticalTreeLayout",MARGIN_TOP:200,MARGIN_LEFT:200,HORGAP:40,VERGAP:60,TREEGAP:50,treeNodeMap:null,init:function(b,a){this.treeNodeMap=new draw2d.util.HashMap();this._super(b,a)},getMoveCommand:function(){var d=this,c=d.initTrees(),b=null,a=d.getRootNodes();a.each(function(f,e){e.clsssifyNodesByDepth();d.layoutRootNodes(e,b);b=e})},layoutRootNodes:function(b,c){var e=this,d=0;if(c){e.MARGIN_LEFT+=c.getBaseWidth()+e.TREEGAP}var a=b.getMoveCommand(e.MARGIN_LEFT,e.MARGIN_TOP,e.VERGAP,e.HORGAP);$.each(a,function(g,f){e.getRedoStack().add(f)})},initTrees:function(){var f=this,e=this.getFigures(),g=null,a=null,b=null,h=null,d=null,c=null;f.getTreeNodeMap().clear();e.each(function(j,i){g=new draw2d.geo.TreeNode(i);f.addTreeNode(g);b=i.getUpstreamNodes();if(b.getSize()==1){a=b.getFirstElement();c=a.getId();g.setParentNode(f.getTreeNode(c));f.buildRelation(f.getTreeNode(c),g)}else{if(b.getSize()>1){Dep.framework.editor.util.Msg.info("请确保每个节点只有一个父节点");return false}}d=i.getDownstreamNodes();g.getChildrenNodes().clear();d.each(function(k,l){c=l.getId();h=f.getTreeNode(c);if(!h){return}f.buildRelation(g,h)})});return this.getTreeNodeMap()},buildRelation:function(a,b){if(!a){return}a.addChildNode(b);b.setParentNode(a)},getRootNodes:function(){var c=this,b=c.getTreeNodeMap(),a=new draw2d.util.ArrayList();b.each(function(e,d){if(!d.getParentNode()){a.add(d)}});return a},addTreeNode:function(a){this.treeNodeMap.put(a.getId(),a)},getTreeNode:function(a){if(!a){throw"未找到正确的节点"}return this.getTreeNodeMap().get(a)},getTreeNodeMap:function(){return this.treeNodeMap}});draw2d.command.CommandDistributedHorizontal=draw2d.command.CommandAlign.extend({NAME:"draw2d.command.CommandDistributedHorizontal",init:function(a,b){this._super(a,b)},getMoveCommand:function(){var g=this,a=null,d=null,j=null,h=0,e=null,i=0,b=null,f=g.getFigures(),c=0;if(f.isEmpty()||f.getSize<=1){return}f.sort("tx");a=f.getLastElement();d=a.tx;f.sort("x");a=f.getFirstElement();j=d-a.getX();f.each(function(l,k){h+=k.getWidth()});e=f.getSize();i=(j-h)/e;c=a.getX();f.each(function(m,l){b=new draw2d.command.CommandMove(l);b.setPosition(c+m*i,l.getY());g.getRedoStack().add(b);c+=l.getWidth()})}});draw2d.command.CommandDistributedvertical=draw2d.command.CommandAlign.extend({NAME:"draw2d.command.CommandDistributedvertical",init:function(a,b){this._super(a,b)},getMoveCommand:function(){var g=this,a=null,d=null,j=null,i=0,e=null,h=0,c=null,f=g.getFigures(),b=0;if(f.isEmpty()||f.getSize<=1){return}f.sort("by");a=f.getLastElement();d=a.by;f.sort("y");a=f.getFirstElement();j=d-a.getY();f.each(function(l,k){i+=k.getHeight()});e=f.getSize();h=(j-i)/e;b=a.getY();f.each(function(m,l){c=new draw2d.command.CommandMove(l);c.setPosition(l.getX(),b+m*h);g.getRedoStack().add(c);b+=l.getHeight()})}});draw2d.decoration.connection.Decorator.prototype.clone=function(){var me=this,className=eval(this.getClassName()),cloneDec=new className(me.getWidth(),me.getHeight());cloneDec.setColor(this.getColor());cloneDec.setBackgroundColor(this.getBackgroundColor());return cloneDec};draw2d.decoration.connection.Decorator.prototype.getClassName=function(){if(this.NAME){return this.NAME}else{throw"当前类未设置类名"}};draw2d.decoration.connection.Decorator.prototype.getWidth=function(){if(this.width){return this.width}};draw2d.decoration.connection.Decorator.prototype.getHeight=function(){if(this.height){return this.height}};draw2d.decoration.connection.Decorator.prototype.getColor=function(){if(this.color){return this.color}else{throw"未能正确获取装饰类的颜色"}};draw2d.decoration.connection.Decorator.prototype.getBackgroundColor=function(){if(this.backgroundColor){return this.backgroundColor}else{throw"未能正确获取装饰类的背景颜色"}};draw2d.decoration.connection.Decorator.prototype.Scale=function(a){this.setDimension(this.getWidth()/a,this.getHeight()/a);return this};draw2d.geo.TreeNode=Class.extend({NAME:"draw2d.geo.TreeNode",baseWidth:0,baseHeight:0,baseX:0,baseY:0,parentNode:null,childNodes:null,id:null,depth:0,init:function(b,a,d){var c=this;c.childNodes=new draw2d.util.ArrayList();c.depth=0;c.baseWidth=0;c.baseHeight=0;if(b instanceof draw2d.shape.node.Node){c.figure=b;this.setId(b.getId())}if(a instanceof draw2d.geo.TreeNode){c.setParentNode(a)}if($.isArray(d)){this.childNodes=new draw2d.util.ArrayList(d)}if(d instanceof draw2d.util.ArrayList){this.childNodes=d}},clsssifyNodesByDepth:function(){var a=this,b=new draw2d.util.ArrayList(),c=new Array();c[0]=b;b.add(a);if(a.getChildrenNodes().getSize()>0){c[1]=new draw2d.util.ArrayList();a.getChildrenNodes().each(function(d,e){childArray=e.clsssifyNodesByDepth();a.mixtureArrays(c,childArray)})}a.setDepthArray(c);return c},mixtureArrays:function(b,a){$.each(a,function(c,d){if(d instanceof draw2d.util.ArrayList){if(b[c+1]){b[c+1].addAll(d)}else{b[c+1]=d}}})},getMoveCommand:function(e,a,k,g){var m=this,b=[],f=null,h=0,i=0,n=m.getChildrenNodes(),d=[],c=null,l=m.getFigure(),j=e;f=new draw2d.command.CommandMoveByCenter(l);m.setBaseX(e);m.setBaseY(a);h=m.getBaseWidth();i=m.getBaseHeight();f.setPosition(e+(h-l.getWidth())/2,a+m.getDepth()*k);b.push(f);if(n.getSize()>0){n.each(function(p,o){if(c){j=j+c.getBaseWidth();e=m.tempX+c.getBaseWidth()}d=o.getMoveCommand(e+g*p,a+m.getFigureHeight(),k,g);b=b.concat(d);c=o;m.tempX=e})}return b},getDepth:function(){var b=this,a=b.getParentNode();if(a){b.depth=a.getDepth()+1}return b.depth},isRoot:function(){if(this.getParentNode()){return false}else{return true}},isLeaf:function(){var b=this,a=b.getChildrenNodes().getSize();if(a>0){return false}else{return true}},getFigure:function(){return this.figure},getFigureWidth:function(){return this.getFigure().getWidth()},getFigureHeight:function(){return this.getFigure().getHeight()},setParentNode:function(a){this.parentNode=a},getParentNode:function(){return this.parentNode},addChildNode:function(a){if(this.getChildrenNodes().contains(a)){return}this.childNodes.add(a)},getChildrenNodes:function(){return this.childNodes},setBaseWidth:function(a){this.baseWidth=a},getBaseWidth:function(){var a=this;if(this.getChildrenNodes().getSize()<=0){a.baseWidth=a.getFigureWidth()}else{a.baseWidth=0;this.getChildrenNodes().each(function(c,b){a.baseWidth+=(b.getBaseWidth()+40)});if(a.baseWidth<a.getFigureWidth()){a.baseWidth=a.getFigureWidth()}}return a.baseWidth},setBaseHeight:function(a){this.baseHeight=a},getBaseHeight:function(){var a=this,b=a.getChildrenNodes();if(b.getSize()<=0){a.baseHeight=a.getFigureHeight()}else{a.baseHeight=a.getSumHeightByDepth()}return a.baseHeight},getSumHeightByDepth:function(){var c=this,a=c.getDepthArray(),b=c.getFigureHeight();$.each(a,function(e,d){b+=c.getEachHeightByDepth(d)});return b},getEachHeightByDepth:function(d){var c=this,a=0,b=0;d.each(function(e,f){b=f.getFigureHeight();a=a>b?a:b});return a},getSumWidthByDepth:function(){var d=this,b=d.getDepthArray(),c=d.getFigureWidth(),a=0;$.each(b,function(f,e){a=d.getEachWidthByDepth(e);c=c>a?c:a});return c},getEachWidthByDepth:function(d){var c=this,a=0,b=0;d.each(function(e,f){b=f.getFigureWidth();a+=b});return a},setId:function(a){this.id=a},getId:function(){if(this.id){return this.id}else{if(this.figure){return this.figure.getId()}else{throw"未正确获取id"}}},setDepthArray:function(a){this.depthArray=a},getDepthArray:function(){return this.depthArray},setBaseX:function(a){this.baseX=a},getBaseX:function(){return this.baseX},setBaseY:function(a){this.baseY=a},getBaseY:function(){return this.baseY}});draw2d.layout.connection.ConnectionRouter.prototype.clone=function(){var me=this,className=eval(this.getClassName());return new className()};draw2d.layout.connection.ConnectionRouter.prototype.getClassName=function(){if(this.NAME){return this.NAME}else{throw"当前类未设置类名"}};draw2d.layout.locator.FigureStatusIconLocator=draw2d.layout.locator.Locator.extend({NAME:"draw2d.layout.locator.FigureStatusIconLocator",init:function(){this._super()},relocate:function(b,d){var c=d.getParent();var a=c.getBoundingBox();var e=d.getBoundingBox();d.setPosition(((a.w-e.w)|0)+0.5,((a.h-(e.h))|0)+0.5)}});draw2d.layout.locator.FigureLabelLocator=draw2d.layout.locator.Locator.extend({NAME:"draw2d.layout.locator.FigureLabelLocator",init:function(){this._super()},relocate:function(b,d){var c=d.getParent();var a=c.getBoundingBox();var e=d.getBoundingBox();d.setPosition(((a.w-e.w)/2)+0.5,(a.h+0.5))}});draw2d.layout.anchor.DepFanConnectionAnchor=draw2d.layout.anchor.FanConnectionAnchor.extend({NAME:"draw2d.layout.anchor.DepFanConnectionAnchor",getBox:function(){var a=this.getOwner().getParent().getBoundingBox();a.setHeight(a.getHeight()+20);return a},});draw2d.layout.connection.InteractiveManhattanBridgedConnectionRouter=draw2d.layout.connection.ManhattanBridgedConnectionRouter.extend({NAME:"draw2d.layout.connection.InteractiveManhattanBridgedConnectionRouter",init:function(){this._super()},onInstall:function(a){a.installEditPolicy(new draw2d.policy.line.OrthogonalSelectionFeedbackPolicy());if(!a._routingMetaData){a._routingMetaData={routedByUserInteraction:false,fromDir:-1,toDir:-1}}},onUninstall:function(a){delete a._routingMetaData},route:function(a,b){if(b.getSize()===0||a._routingMetaData.routedByUserInteraction===false){this._super(a,b);a._routingMetaData.fromDir=a.getSource().getConnectionDirection(a,a.getTarget());a._routingMetaData.toDir=a.getTarget().getConnectionDirection(a,a.getSource())}else{this._cusRoute(a,b);this.intersectionsRepaint(a)}},_cusRoute:function(a,b){this.halfRoute(a,b)},halfRoute:function(c,j){var a=j.getSize();var d=c.getStartPoint();var f=c.getSource().getConnectionDirection(c,c.getTarget());var k=c.getEndPoint();var b=c.getTarget().getConnectionDirection(c,c.getSource());var g=Math.max;var e=Math.min;if(c._routingMetaData.fromDir!==f||c._routingMetaData.toDir!==b){c._routingMetaData.routedByUserInteraction=false;this._cusRoute(c,j)}if((f===1)&&(b===3)&&(d.x>k.x)&&(a<=4)){c._routingMetaData.routedByUserInteraction=false;this._cusRoute(c,j)}j.each(function(l,m){c.addPoint(m)});if(!d.equals(j.get(0))){var i=j.get(1);var h=j.get(2);c.setVertex(0,d);switch(f){case draw2d.geo.Rectangle.DIRECTION_RIGHT:c.setVertex(1,g(d.x+10,i.x),d.y);c.setVertex(2,g(d.x+10,i.x),h.y);break;case draw2d.geo.Rectangle.DIRECTION_LEFT:c.setVertex(1,e(d.x-10,i.x),d.y);c.setVertex(2,e(d.x-10,i.x),h.y);break;case draw2d.geo.Rectangle.DIRECTION_UP:c.setVertex(1,d.x,e(d.y-10,i.y));c.setVertex(2,h.x,e(d.y-10,i.y));break;case draw2d.geo.Rectangle.DIRECTION_DOWN:c.setVertex(1,d.x,g(d.y+10,i.y));c.setVertex(2,h.x,g(d.y+10,i.y));break}}if(!k.equals(j.get(a-1))){var i=j.get(a-2);var h=j.get(a-3);c.setVertex(a-1,k);switch(b){case draw2d.geo.Rectangle.DIRECTION_RIGHT:c.setVertex(a-2,g(k.x+10,i.x),k.y);c.setVertex(a-3,g(k.x+10,i.x),h.y);break;case draw2d.geo.Rectangle.DIRECTION_LEFT:c.setVertex(a-2,e(k.x-10,i.x),k.y);c.setVertex(a-3,e(k.x-10,i.x),h.y);break;case draw2d.geo.Rectangle.DIRECTION_UP:c.setVertex(a-2,k.x,g(k.y+10,i.y));c.setVertex(a-3,h.x,g(k.y+10,i.y));break;case draw2d.geo.Rectangle.DIRECTION_DOWN:c.setVertex(a-2,k.x,g(k.y+10,i.y));c.setVertex(a-3,h.x,g(k.y+10,i.y));break}}},canRemoveSegmentAt:function(c,i){var f=c.getVertices().getSize()-1;if((i<=0)||(i>=f)){return false}if(f<4){return false}var e=c.getStartPoint();var h=c.getSource().getConnectionDirection(c,c.getTarget());var j=c.getEndPoint();var b=c.getTarget().getConnectionDirection(c,c.getSource());if(f<=5){if((h===draw2d.geo.Rectangle.DIRECTION_RIGHT)&&(b===draw2d.geo.Rectangle.DIRECTION_LEFT)&&(e.x>=j.x)){return false}if((h==draw2d.geo.Rectangle.DIRECTION_LEFT)&(b==draw2d.geo.Rectangle.DIRECTION_RIGHT)&&(e.x<=j.x)){return false}if((h==draw2d.geo.Rectangle.DIRECTION_UP)&(b==draw2d.geo.Rectangle.DIRECTION_DOWN)&&(e.y<=j.y)){return false}if((h==draw2d.geo.Rectangle.DIRECTION_DOWN)&(b==draw2d.geo.Rectangle.DIRECTION_UP)&&(e.y>=j.y)){return false}var d=new draw2d.Connection();d.lineSegments=new draw2d.util.ArrayList();d.vertices=new draw2d.util.ArrayList();d.sourcePort=c.sourcePort;d.targetPort=c.targetPort;d._routingMetaData={routedByUserInteraction:false,fromDir:-1,toDir:-1};this._cusRoute(d,new draw2d.util.ArrayList());var a=c.getVertices().getSize()-1;var g=d.getVertices().getSize()-1;if(a<=g){return false}}return true},getPersistentAttributes:function(a,b){b.vertex=[];a.getVertices().each(function(c,d){b.vertex.push({x:d.x,y:d.y})});b.routingMetaData=$.extend({},a._routingMetaData);return b},setPersistentAttributes:function(a,b){if(typeof b.vertex!=="undefined"){a.oldPoint=null;a.lineSegments=new draw2d.util.ArrayList();a.vertices=new draw2d.util.ArrayList();$.each(b.vertex,function(c,d){a.addPoint(d.x,d.y)})}if(typeof b.routingMetaData!=="undefinied"){a._routingMetaData=$.extend({},b.routingMetaData)}},intersectionsRepaint:function(d){var l=d.getCanvas().getIntersection(d).sort("x");var j=l.clone().reverse();var e=l;var g=0;var a=d.getVertices();var b=a.get(0);var k=["M",(b.x|0)+0.5," ",(b.y|0)+0.5];var c=b;for(g=1;g<a.getSize();g++){b=a.get(g);var h=5;var f=this.BRIDGE_HORIZONTAL_LR;if(c.x>b.x){e=j;f=this.BRIDGE_HORIZONTAL_RL;h=-h}e.each(function(i,m){if(m.justTouching==false&&draw2d.shape.basic.Line.hit(1,c.x,c.y,b.x,b.y,m.x,m.y)===true){if(Math.abs(b.y-m.y)<2){k.push(" L",((m.x-h)|0)+0.5," ",(m.y|0)+0.5);k.push(f)}}});k.push(" L",(b.x|0)+0.5," ",(b.y|0)+0.5);c=b}d.svgPathString=k.join("")}});draw2d.layout.connection.DepManhattanConnectionRouter=draw2d.layout.connection.ConnectionRouter.extend({NAME:"draw2d.layout.connection.DepManhattanConnectionRouter",MINDIST:20,TOL:0.1,TOLxTOL:0.01,TOGGLE_DIST:5,init:function(){this._super()},onInstall:function(a){a.installEditPolicy(new draw2d.policy.line.LineSelectionFeedbackPolicy())},route:function(d,f){var a=d.getStartPoint();var c=d.clone();var h=d.getEndPoint();var b=a.y-h.y;var g=0,e=0;if(b<0){e=g=draw2d.geo.Rectangle.DIRECTION_DOWN}else{e=g=draw2d.geo.Rectangle.DIRECTION_UP}this._route(d,a,e,h,g);this._paint(d)},_route:function(d,e,f,n,c){d.addPoint(e);var m=draw2d.geo.Rectangle.DIRECTION_UP;var g=draw2d.geo.Rectangle.DIRECTION_RIGHT;var k=draw2d.geo.Rectangle.DIRECTION_DOWN;var a=draw2d.geo.Rectangle.DIRECTION_LEFT;var j=e.x-n.x;var h=e.y-n.y;var l;var b;if(((j*j)<(this.TOLxTOL))&&((h*h)<(this.TOLxTOL))){d.addPoint(new draw2d.geo.Point(n.x,n.y));return}if(f===a){if((j>0)&&((h*h)<this.TOL)&&(c===a)){l=n;b=c}else{if(j<0){l=new draw2d.geo.Point(e.x-this.MINDIST,e.y)}else{if(((h>0)&&(c===m))||((h<0)&&(c===k))){l=new draw2d.geo.Point(n.x,e.y)}else{if(f==c){var i=Math.max(e.x,n.x)-this.MINDIST;l=new draw2d.geo.Point(i,e.y)}else{l=new draw2d.geo.Point(e.x-(j/2),e.y)}}}if(h>0){b=m}else{b=k}}}else{if(f===g){if((j<0)&&((h*h)<this.TOL)&&(c===g)){l=n;b=c}else{if(j>0){l=new draw2d.geo.Point(e.x+this.MINDIST,e.y)}else{if(((h>0)&&(c===m))||((h<0)&&(c===k))){l=new draw2d.geo.Point(n.x,e.y)}else{if(f===c){var i=Math.min(e.x,n.x)+this.MINDIST;l=new draw2d.geo.Point(i,e.y)}else{l=new draw2d.geo.Point(e.x-(j/2),e.y)}}}if(h>0){b=m}else{b=k}}}else{if(f===k){if(((j*j)<this.TOL)&&(h<0)&&(c===m)){l=n;b=c}else{if(h>0){l=new draw2d.geo.Point(e.x,e.y+this.MINDIST)}else{if(((j>0)&&(c===a))||((j<0)&&(c===g))){l=new draw2d.geo.Point(e.x,n.y)}else{l=new draw2d.geo.Point(e.x,e.y-(h/2))}}if(j>0){b=a}else{b=g}}}else{if(f===m){if(((j*j)<this.TOL)&&(h>0)&&(c===m)){l=n;b=c}else{if(h<0){l=new draw2d.geo.Point(e.x,e.y-this.MINDIST)}else{if(((j>0)&&(c===a))||((j<0)&&(c===g))){l=new draw2d.geo.Point(e.x,n.y)}else{l=new draw2d.geo.Point(e.x,e.y-(h/2))}}if(j>0){b=a}else{b=g}}}}}}this._route(d,l,b,n,c)}});draw2d.layout.connection.DepSplineConnectionRouter=draw2d.layout.connection.SplineConnectionRouter.extend({NAME:"draw2d.layout.connection.DepSplineConnectionRouter",init:function(){this._super();this.spline=new draw2d.util.spline.CubicSpline();this.MINDIST=50,this.cheapRouter=null},route:function(d,j){var f=0;var e=d.getStartPoint();var h=2;var l=d.getEndPoint();var c=0;this._route(d,l,c,e,h);var a=d.getVertices();d.oldPoint=null;d.lineSegments=new draw2d.util.ArrayList();d.vertices=new draw2d.util.ArrayList();var g=this.spline.generate(a,8);g.each(function(m,n){d.addPoint(n)});var a=d.getVertices();length=a.getSize();var b=a.get(0);var k=["M",b.x," ",b.y];for(f=1;f<length;f++){b=a.get(f);k.push("L",b.x," ",b.y)}d.svgPathString=k.join("")}});var ROUTER_RECTS=null;draw2d.layout.connection.DepMazeConnectionRouter=draw2d.layout.connection.MazeConnectionRouter.extend({NAME:"draw2d.layout.connection.DepMazeConnectionRouter",init:function(){this._super()},route:function(b,d){var a=b.getStartPoint();var c=2;var f=b.getEndPoint();var e=0;this._route(b,f,e,a,c);b.getVertices().reverse();this._paint(b)}});draw2d.policy.line.LineDragDropPolicy=draw2d.policy.figure.DragDropEditPolicy.extend({NAME:"draw2d.policy.line.LineDragDropPolicy",init:function(){this._super()},onDragStart:function(c,b,a,g,d,f){var e=this;if(a==0&&g==0){return}e.selectionSegment=e.getRelationSegment(b,a+b.getAbsoluteX(),g+b.getAbsoluteY());b.isMoving=false},getRelationSegment:function(a,d,b){for(var c=0;c<a.lineSegments.getSize();c++){var e=a.lineSegments.get(c);if(draw2d.shape.basic.Line.hit(5,e.start.x,e.start.y,e.end.x,e.end.y,d,b)){return{index:c,start:e.start,end:e.end}}}},onDrag:function(d,i,n,l,k,f){var h=this;if(!h.selectionSegment){return}if(h.selectionSegment.index==i.lineSegments.getSize()-1){return}if(Math.abs(h.selectionSegment.start.x-h.selectionSegment.end.x)<3){if(h.selectionSegment.index==0){var e=i.getSource();var b=e.getX()+f;var j=e.getParent();var c=j.getWidth();if(b<0){b=0}if(b>c){b=c}e.setX(b);e.fireEvent("move");e.fireEvent("change:x")}else{if(h.selectionSegment.index==i.lineSegments.getSize()-1){var g=i.getTarget();var b=g.getX()+f;var j=g.getParent();var c=j.getWidth();if(b<0){b=0}if(b>c){b=c}g.setX(b);g.fireEvent("move");g.fireEvent("change:x")}else{i.setVertex(h.selectionSegment.index,h.selectionSegment.start.x+k,h.selectionSegment.start.y);i.setVertex(h.selectionSegment.index+1,h.selectionSegment.end.x+k,h.selectionSegment.end.y)}}}else{if(Math.abs(h.selectionSegment.start.y-h.selectionSegment.end.y)<3){if(h.selectionSegment.index==0){var e=i.getSource();var m=e.getY()+f;var j=e.getParent();var a=j.getHeight();if(m<0){m=0}if(m>a){m=a}e.setY(m);e.fireEvent("move");e.fireEvent("change:y")}else{if(h.selectionSegment.index==i.lineSegments.getSize()-1){var g=i.getTarget();var m=g.getY()+f;var j=g.getParent();var a=j.getHeight();if(m<0){m=0}if(m>a){m=a}g.setY(m);g.fireEvent("move");g.fireEvent("change:y")}else{i.setVertex(h.selectionSegment.index,h.selectionSegment.start.x,h.selectionSegment.start.y+f);i.setVertex(h.selectionSegment.index+1,h.selectionSegment.end.x,h.selectionSegment.end.y+f)}}}}i._routingMetaData.routedByUserInteraction=true;i.routingRequired=true;return true},onDragEnd:function(b,g,i,h,f,a){if(g instanceof draw2d.Connection){var c=new draw2d.util.ArrayList();b.calculateConnectionIntersection();b.lineIntersections.each(function(k,j){if(!c.contains(j.line)){c.add(j.line)}if(!c.contains(j.other)){c.add(j.other)}});c.each(function(k,j){j.svgPathString=null;j.repaint()});var e=g.getTargetNode(),d=g.getSourceNode();e.portRelayoutRequired=true;d.portRelayoutRequired=true;e.layoutPorts();d.layoutPorts()}g.isMoving=false},moved:function(b,a){}});draw2d.policy.canvas.AddLinkPolicy=draw2d.policy.canvas.SingleSelectionPolicy.extend({NAME:"draw2d.policy.canvas.AddLinkPolicy",init:function(){this._super()},select:function(c,a){if(c.getSelection().contains(a)){return}var b=c.getSelection().getPrimary();if(a!==null){a.select(true)}if(b!==a){c.getSelection().setPrimary(a);c.fireEvent("select",a)}},onMouseDown:function(b,j,i,h,a){try{var e=this;var d=b.getCurrentModel();if(!d){return}this.x=j;this.y=i;var c=b.getSelection().getAll();var g=b.getBestFigure(j,i);e.currentEditFigure=null;if(!g){return}while(g!==null&&g.getComposite()!==null){var f=g.getComposite().delegateSelectionHandling(g);if(f===g){break}g=f}while((g!==null&&g.getParent()!==null)&&!(g instanceof draw2d.Port)){g=g.getParent()}if(g!==null){if(!e._valivateOutPutFigureByLinkModel(b,g)){return}e.currentEditFigure=g;g.onAddLinkStart(j,i,h,a)}c.each(function(m,l){e.unselect(b,l)})}catch(k){console.log(k)}},onMouseDrag:function(e,d,c,f,b){try{if(this.currentEditFigure){this.currentEditFigure.onAddLinkDrag(d,c,f,b)}}catch(a){console.log(a)}},onMouseUp:function(b,i,h,f,a){try{var d=this;if(!d.currentEditFigure){if(!b.isDblClicked()){b.getOutOfAddLinkState(null,false)}return}var c=b.getSelection().getAll();var g=b.getBestFigure(i,h);if(!g){d.currentEditFigure.onAddLinkDrop(null,i,h,f,a);return}while(g!==null&&g.getComposite()!==null){var e=g.getComposite().delegateSelectionHandling(g);if(e===g){break}g=e}while((g!==null&&g.getParent()!==null)&&!(g instanceof draw2d.Port)){g=g.getParent()}if(g!==null){if(!d._valivateFigureByLinkModel(b,g)){d.currentEditFigure.onAddLinkDrop(null,i,h,f,a);if(!b.isDblClicked()){b.getOutOfAddLinkState(null,false)}return}d.currentEditFigure.onAddLinkDrop(g,i,h,f,a);if(!b.isDblClicked()){b.getOutOfAddLinkState(null,false)}}}catch(j){console.log(j)}},_valivateOutPutFigureByLinkModel:function(d,a){var g=this,c=d.getCurrentModel(),e=c.get("connectionConfig"),f=a.getFigureType(),b=false;if(!e){return true}else{$.each(e,function(i,h){if(f==h.sourceNodeType){b=true;return false}})}return b},_valivateFigureByLinkModel:function(d,a){var g=this,c=d.getCurrentModel(),e=c.get("connectionConfig"),f=a.getFigureType(),b=false;if(!e){return true}else{$.each(e,function(i,h){if(h.destPortType&&f==h.destPortType){b=true;return false}else{if(!(a instanceof Dep.framework.editor.figure.BaseNode)){f=a.getParent().getFigureType()}if(h.destNodeType&&f==h.destNodeType){b=true;return false}}})}return b}});draw2d.policy.canvas.DragDropCanvasPolicy=draw2d.policy.canvas.SingleSelectionPolicy.extend({NAME:"draw2d.policy.canvas.DragDropCanvasPolicy",init:function(){this._super()},select:function(c,a){if(c.getSelection().contains(a)){return}var b=c.getSelection().getPrimary();if(a!==null){a.select(true)}if(b!==a){c.getSelection().setPrimary(a);c.fireEvent("select",a)}},onMouseDown:function(c,b,g,d,e){try{var f=this;this.x=b;this.y=g}catch(a){console.log(a)}},onMouseDrag:function(e,d,c,f,b){try{e.onMouseMoveCanvas(d,c,f,b)}catch(a){console.log(a)}},onMouseUp:function(c,b,g,d,e){try{var f=this}catch(a){console.log(a)}}});draw2d.policy.port.IntrusivePortsFeedbackPolicy.prototype.onDragStart=function(d,b,a,h,e,f){var g=0;var c=d.getAllPorts().clone();c.each(function(k,j){j.__beforeInflate=j.getWidth();g=j.__beforeInflate});c.grep(function(i){return(i.NAME!=b.NAME&&i.parent!==b.parent)||(i instanceof draw2d.HybridPort)||(b instanceof draw2d.HybridPort)});this.tweenable=new Tweenable();this.tweenable.tween({from:{size:g/2},to:{size:g},duration:200,easing:"easeOutSine",step:function(i){c.each(function(k,j){j.shape.attr({rx:i.size,ry:i.size});j.width=j.height=i.size*2;if(j.showTips){j.showTips()}})}});this.connectionLine=new draw2d.shape.basic.Line();this.connectionLine.setCanvas(d);this.connectionLine.getShapeElement();this.connectionLine.setDashArray("- ");this.connectionLine.setColor("#30c48a");this.onDrag(d,b)};draw2d.policy.port.IntrusivePortsFeedbackPolicy.prototype.onDragEnd=function(c,b,a,f,d,e){this.tweenable.stop(false);this.tweenable=null;c.getAllPorts().each(function(h,g){g.shape.attr({rx:g.__beforeInflate/2,ry:g.__beforeInflate/2});if(g.hideTips){g.hideTips()}g.width=g.height=g.__beforeInflate});this.connectionLine.setCanvas(null);this.connectionLine=null};draw2d.policy.port.BoundingMovePolicy=draw2d.policy.port.PortFeedbackPolicy.extend({NAME:"draw2d.policy.port.BoundingMovePolicy",UPDOWN:2,LEFTRIGHT:1,TOPLEFT:"topleft",TOPRIGHT:"topright",BOTTOMLEFT:"bottomleft",BOTTOMRIGHT:"bottomright",init:function(){this._super()},reCaculatePostion:function(h,l,k,b,j){var s=this,f=h.getParent(),p=0,o=p+f.getWidth(),n=0,m=f.getHeight()+n,i=h.getX(),g=h.getY(),d=h.ox,c=h.oy,e=null,a=null,r=0,q=0;if(i==0||i==f.getWidth()){a=s.UPDOWN}else{if(g==0||g==f.getHeight()){a=s.LEFTRIGHT}}if(s.getSpecialPosition(h,f,b,j)){if(Math.abs(b)>Math.abs(j)){a=s.LEFTRIGHT}else{if(Math.abs(b)<Math.abs(j)){a=s.UPDOWN}}}if(!a){if(i<g){if(i>o/2){i=o}else{i=0}}else{if(g>m/2){g=m}else{g=0}}e=new draw2d.geo.Point(i,g);return e}switch(a){case s.LEFTRIGHT:r=d+l;if(r>o){r=o}else{if(r<p){r=p}}e=new draw2d.geo.Point(r,c);break;case s.UPDOWN:q=c+k;if(q>m){q=m}else{if(q<n){q=n}}e=new draw2d.geo.Point(d,q);break;default:e=new draw2d.geo.Point(d+l,c+k)}return e},getSpecialPosition:function(d,f){var g=this,c=false,b=d.getX(),h=d.getY(),e=f.getWidth(),a=f.getHeight();if(b==h&&h==0){c=g.TOPLEFT}else{if(b==e&&h==0){c=g.TOPRIGHT}else{if(b==0&&h==a){c=g.BOTTOMLEFT}else{if(b==e&&h==a){c=g.BOTTOMRIGHT}}}}if(c){d.ox=b;d.oy=h}return c}});draw2d.policy.port.PortSelectionPolicy=draw2d.policy.figure.SelectionFeedbackPolicy.extend({NAME:"draw2d.port.figure.PortSelectionPolicy",init:function(){this._super()},onSelect:function(b,a,c){if(a instanceof draw2d.Port){a.setGlow(true)}},onUnselect:function(b,a){if(a instanceof draw2d.Port){a.setGlow(false)}}});draw2d.shape.basic.OutlineSizer=draw2d.shape.node.Node.extend({NAME:" draw2d.shape.basic.OutlineSizer",init:function(b,c,a){this.stroke=1;this.radius=0;this.color=new draw2d.util.Color("#303030");this.strokeBeforeGlow=this.stroke;this.glowIsActive=false;this._super(b,c,a);this.setSelectable(false)},reInstallEditPolicy:function(a){var b=this;b.editPolicy.each(function(c,d){b.uninstallEditPolicy(d)});b.installEditPolicy(new draw2d.policy.figure.RegionEditPolicy(0,0,a.getWidth(),a.getHeight()))},setCanvas:function(a){this._super(a);if(a instanceof draw2d.Canvas){this.reInstallEditPolicy(a)}},createShapeElement:function(){return this.canvas.paper.rect(this.getAbsoluteX(),this.getAbsoluteY(),this.getWidth(),this.getHeight())},onDrag:function(c,b,d,a){var e=this;e._super(c,b,d,a);e.fireEvent(Dep.framework.editor.EVENT.OUTLINE.SIZERMOVED,{x:this.x,y:this.y});e.setAlpha(1)},repaint:function(a){if(this.repaintBlocked===true||this.shape===null){return}a=a||{};a.x=this.getAbsoluteX();a.y=this.getAbsoluteY();a=$.extend({},{width:this.getWidth(),height:this.getHeight()},a);if(this.dasharray!==null){a["stroke-dasharray"]=this.dasharray}if(typeof a.stroke==="undefined"){if(this.color===null||this.stroke===0){a.stroke="none"}else{a.stroke=this.color.hash()}}if(typeof a["stroke-width"]==="undefined"){a["stroke-width"]=this.stroke}this._super(a);return this}});draw2d.shape.basic.FigureLabel=draw2d.shape.basic.Label.extend({NAME:"draw2d.shape.basic.FigureLabel",FONT_FALLBACK:{Georgia:"Georgia, serif","Palatino Linotype":'"Palatino Linotype", "Book Antiqua", Palatino, serif',"Times New Roman":'"Times New Roman", Times, serif',Arial:"Arial, Helvetica, sans-serif","Arial Black":'"Arial Black", Gadget, sans-serif',"Comic Sans MS":'"Comic Sans MS", cursive, sans-serif',Impact:"Impact, Charcoal, sans-serif","Lucida Sans Unicode":'"Lucida Sans Unicode", "Lucida Grande", sans-serif',"Tahoma, Geneva":"Tahoma, Geneva, sans-seri","Trebuchet MS":'"Trebuchet MS", Helvetica, sans-serif',Verdana:"Verdana, Geneva, sans-serif","Courier New":'"Courier New", Courier, monospace',"Lucida Console":'"Lucida Console", Monaco, monospace'},init:function(b,c,a){var d=this;d.text=b;if(c){d.width=c}else{d.width=20}if(a){d.height=a}else{d.height=20}d._super($.extend({stroke:0,width:d.width,height:d.height,resizeable:false},{}),{},{})},calculateTextAttr:function(){var a={"text-anchor":"start","font-size":this.fontSize,"font-weight":(this.bold===true)?"bold":"normal",fill:this.fontColor.hash(),stroke:this.outlineColor.hash(),"stroke-width":this.outlineStroke};if(this.fontFamily!==null){a["font-family"]=this.fontFamily}return a}});draw2d.shape.basic.ConnectionLabel=draw2d.shape.basic.Label.extend({NAME:"draw2d.shape.basic.ConnectionLabel",init:function(){var a=this;a._super({color:"#0d0d0d",fontColor:"#0d0d0d",bgColor:"#ffffff"})}});draw2d.shape.basic.Image.prototype.getZOrder=function(a){if(!this.zOrder){draw2d.Figure.prototype.getZOrder.call(this,a)}else{return this.zOrder}};draw2d.shape.basic.Image.prototype.setZOrder=function(a){this.zOrder=a};draw2d.shape.node.Node.prototype.setVisible=function(a){if(!a){this.getPorts().each(function(c,b){if(!b.__initialVisibilityState){b.__initialVisibilityState=b.isVisible()}b.setVisible(false)})}else{this.getPorts().each(function(c,b){if(typeof b.__initialVisibilityState!=="undefined"){b.setVisible(b.__initialVisibilityState)}delete b.__initialVisibilityState})}draw2d.Figure.prototype.setVisible.call(this,a)};